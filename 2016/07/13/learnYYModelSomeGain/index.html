<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="李剑飞" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/avatar2.png?v=5.1.0" />






<meta name="description" content="编程随想：学习技术的三部曲 WHAT  “WHAT”也就是“What is it?”——这是最简单的层次。在这个层次，你要搞清楚某个东东是    什么样子的？有什么用？有什么功能特性？有什么语法？…… HOW  所谓的“HOW”就是“How to do?”。在这个层次，你要搞清楚某个东西，其内部是如何运作    的？如何实现的？…… WHY  一般来说，只有想清楚HOW之后，才能继续去考虑WHY。">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="看 YYModel 源码的一些收获">
<meta property="og:url" content="http://www.lijianfei.cn/2016/07/13/learnYYModelSomeGain/index.html">
<meta property="og:site_name" content="李剑飞的博客">
<meta property="og:description" content="编程随想：学习技术的三部曲 WHAT  “WHAT”也就是“What is it?”——这是最简单的层次。在这个层次，你要搞清楚某个东东是    什么样子的？有什么用？有什么功能特性？有什么语法？…… HOW  所谓的“HOW”就是“How to do?”。在这个层次，你要搞清楚某个东西，其内部是如何运作    的？如何实现的？…… WHY  一般来说，只有想清楚HOW之后，才能继续去考虑WHY。">
<meta property="og:image" content="http://7xraw1.com1.z0.glb.clouddn.com/Declared%20property%20type%20encodings-OC.png">
<meta property="og:image" content="http://7xraw1.com1.z0.glb.clouddn.com/OC%20type%20encodings.png">
<meta property="og:image" content="http://7xraw1.com1.z0.glb.clouddn.com/OC%20method%20encodings.png">
<meta property="og:image" content="http://7xraw1.com1.z0.glb.clouddn.com/runtime_meta_class.png">
<meta property="og:image" content="http://7xraw1.com1.z0.glb.clouddn.com/runtime_mata_class_son.png">
<meta property="og:updated_time" content="2016-09-13T03:03:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="看 YYModel 源码的一些收获">
<meta name="twitter:description" content="编程随想：学习技术的三部曲 WHAT  “WHAT”也就是“What is it?”——这是最简单的层次。在这个层次，你要搞清楚某个东东是    什么样子的？有什么用？有什么功能特性？有什么语法？…… HOW  所谓的“HOW”就是“How to do?”。在这个层次，你要搞清楚某个东西，其内部是如何运作    的？如何实现的？…… WHY  一般来说，只有想清楚HOW之后，才能继续去考虑WHY。">
<meta name="twitter:image" content="http://7xraw1.com1.z0.glb.clouddn.com/Declared%20property%20type%20encodings-OC.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.lijianfei.cn/2016/07/13/learnYYModelSomeGain/"/>





  <title> 看 YYModel 源码的一些收获 | 李剑飞的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  











  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1260409211&web_id=1260409211" language="JavaScript"></script>
  </div>






  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">李剑飞的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.lijianfei.cn/2016/07/13/learnYYModelSomeGain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李剑飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李剑飞的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                看 YYModel 源码的一些收获
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-13T11:02:20+08:00">
                2016-07-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="编程随想：学习技术的三部曲"><a href="#编程随想：学习技术的三部曲" class="headerlink" title="编程随想：学习技术的三部曲"></a>编程随想：学习技术的三部曲</h1><ul>
<li>WHAT<br>  “WHAT”也就是“What is it?”——这是最简单的层次。在这个层次，你要搞清楚某个东东是    什么样子的？有什么用？有什么功能特性？有什么语法？……</li>
<li>HOW<br>  所谓的“HOW”就是“How to do?”。在这个层次，你要搞清楚某个东西，其内部是如何运作    的？如何实现的？……</li>
<li>WHY<br>  一般来说，只有想清楚HOW之后，才能继续去考虑WHY。所谓的“WHY”，就是搞清楚某个东西为什么设计成这样？为什么不是另外的样子？这样的设计有什么讲究？……<br>说实在的，善于问“为什么”有一定的天赋成分？好像某个科学大牛曾经说过“提出问题有时候    比解决问题更难”。一般来说，只有当你深刻理解了某个东西，才能够针对这个东东的设计问    出一些问题。所以，先把HOW的问题搞清楚，再来考虑WHY的问题。</li>
</ul>
<h1 id="关于源码学习自己的一些感悟"><a href="#关于源码学习自己的一些感悟" class="headerlink" title="关于源码学习自己的一些感悟"></a>关于源码学习自己的一些感悟</h1><ol>
<li>第一层：熟练使用；</li>
<li>第二层：读懂代码；</li>
<li>第三层：通晓原理；</li>
<li>第四层：如何设计；</li>
</ol>
<p>自己学到了什么，还留有什么问题；</p>
<h1 id="关于分享"><a href="#关于分享" class="headerlink" title="关于分享"></a>关于分享</h1><blockquote>
<p>关于线下演讲分享和线上文章分享，我一直觉得技术领域要学东西的话线上文章分享是最好的形式，一是它传播广，触达用户多；二是耗时少，写一篇文章或看一篇文章都比听一个分享花的时间少很多；三是可沉淀，读者可以反复看细节，可以沉淀下来不断被人搜索到。 –  Bang （JSPatch 作者）</p>
</blockquote>
<h1 id="YYModel-作者性能优化的几个-Tip："><a href="#YYModel-作者性能优化的几个-Tip：" class="headerlink" title="YYModel 作者性能优化的几个 Tip："></a>YYModel 作者性能优化的几个 Tip：</h1><ol>
<li><p>缓存</p>
<p> Model JSON 转换过程中需要很多类的元数据，如果数据足够小，则全部缓存到内存中。</p>
</li>
<li><p>查表</p>
<p> 当遇到多项选择的条件时，要尽量使用查表法实现，比如 switch/case，C Array，如果查表条件是对象，则可以用 NSDictionary 来实现。</p>
</li>
<li><p>避免 KVC</p>
<p> Key-Value Coding 使用起来非常方便，但性能上要差于直接调用 Getter/Setter，所以如果能避免 KVC 而用 Getter/Setter 代替，性能会有较大提升。</p>
</li>
<li><p>避免 Getter/Setter 调用</p>
<p> 如果能直接访问 ivar，则尽量使用 ivar 而不要使用 Getter/Setter 这样也能节省一部分开销。</p>
</li>
<li><p>避免多余的内存管理方法</p>
<p> 在 ARC 条件下，默认声明的对象是 <strong>strong 类型的，赋值时有可能会产生 retain/release 调用，如果一个变量在其生命周期内不会被释放，则使用 </strong>unsafe_unretained 会节省很大的开销。</p>
<p> 访问具有 <strong>weak 属性的变量时，实际上会调用 objc_loadWeak() 和 objc_storeWeak() 来完成，这也会带来很大的开销，所以要避免使用 </strong>weak 属性。</p>
<p> 创建和使用对象时，要尽量避免对象进入 autoreleasepool，以避免额外的资源开销。</p>
</li>
<li><p>遍历容器类时，选择更高效的方法</p>
<p> 相对于 Foundation 的方法来说，CoreFoundation 的方法有更高的性能，用 CFArrayApplyFunction() 和 CFDictionaryApplyFunction() 方法来遍历容器类能带来不少性能提升，但代码写起来会非常麻烦。</p>
</li>
<li><p>尽量用纯 C 函数、内联函数</p>
<p> 使用纯 C 函数可以避免 ObjC 的消息发送带来的开销。如果 C 函数比较小，使用 inline 可以避免一部分压栈弹栈等函数调用的开销。</p>
</li>
<li><p>减少遍历的循环次数</p>
<p> 在 JSON 和 Model 转换前，Model 的属性个数和 JSON 的属性个数都是已知的，这时选择数量较少的那一方进行遍历，会节省很多时间。</p>
</li>
</ol>
<hr>
<h1 id="YYModel-源码学习篇"><a href="#YYModel-源码学习篇" class="headerlink" title="YYModel 源码学习篇"></a>YYModel 源码学习篇</h1><h2 id="把不熟练的一些代码挑出来，弄清楚"><a href="#把不熟练的一些代码挑出来，弄清楚" class="headerlink" title="把不熟练的一些代码挑出来，弄清楚"></a>把不熟练的一些代码挑出来，弄清楚</h2><h3 id="NS-ASSUME-NONNULL-BEGIN-NS-ASSUME-NONNULL-END"><a href="#NS-ASSUME-NONNULL-BEGIN-NS-ASSUME-NONNULL-END" class="headerlink" title="NS_ASSUME_NONNULL_BEGIN / NS_ASSUME_NONNULL_END"></a>NS_ASSUME_NONNULL_BEGIN / NS_ASSUME_NONNULL_END</h3><p>为了防止写一大堆 nonnull(不可为nil)，Foundation 还提供了一对儿宏，包在里面的对象默认加 nonnull 修饰符，只需要把 nullable 的指出来就行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NS_ASSUME_NONNULL_BEGIN</div><div class="line">@interface Sark : NSObject</div><div class="line">@property (nonatomic, copy, nullable) NSString *workingCompany;</div><div class="line">@property (nonatomic, copy) NSArray *friends;</div><div class="line">- (nullable NSString *)gayFriend;</div><div class="line">@end</div><div class="line">NS_ASSUME_NONNULL_END</div></pre></td></tr></table></figure></p>
<h3 id="define-force-inline-inline-attribute-always-inline"><a href="#define-force-inline-inline-attribute-always-inline" class="headerlink" title="#define force_inline inline attribute((always_inline))"></a>#define force_inline <strong>inline</strong> <strong>attribute</strong>((always_inline))</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__attribute__((always_inline))的意思是强制内联，所有加了__attribute__((always_inline))的函数再被调用时不会被编译成函数调用而是直接扩展到调用函数体内，比如我定义了函数</div><div class="line"></div><div class="line">__attribute__((always_inline)) void a()</div><div class="line"></div><div class="line">void b()｛a();｝</div><div class="line"></div><div class="line">b调用a函数的汇编代码不会是跳转到a执行，而是a函数的代码直接在b内成为b的一部分。</div></pre></td></tr></table></figure>
<ul>
<li>普通函数<ul>
<li>调用时，会出现流程跳转来回<ul>
<li>首先跳到被调用函数；</li>
<li>被调用函数执行完之后，又会跳会主调函数中；</li>
</ul>
</li>
</ul>
</li>
<li>内联函数<ul>
<li>调用时，直接 将内联函数的代码全部复制到调用的地点；</li>
<li>内联函数的定义必须出现在调用之前；</li>
<li>牺牲内存空间，来提高函数执行速度；</li>
</ul>
</li>
<li>内联函数的不足<ul>
<li>通常，编译器比程序设计者更清楚对于一个特定的函数是否合适进行内联扩展；一些情况下，对于程序员指定的某些内联函数，编译器可能更倾向于不使用内联甚至根本无法完成内联。<ul>
<li>代码比较长的，即使声明为inline，也不会最终内联</li>
<li>而有的一些比较短的小函数，即使没有声明inline，也会由c/c++编译器最终内联</li>
<li>而如果函数使用强制内联，那么最终就一定是内联</li>
</ul>
</li>
<li>对于一些开发中的函数，它们可能从原来的不适合内联扩展变得适合或者倒过来。尽管内联函数或者非内联函数的转换易于宏的转换，但增加的维护开支还是使得它的优点显得更不突出了。</li>
<li>对于基于C的编译系统，内联函数的使用可能大大增加编译时间，因为每个调用该函数的地方都需要替换成函数体，代码量的增加也同时带来了潜在的编译时间的增加。</li>
</ul>
</li>
</ul>
<p><a href="http://www.cnblogs.com/MyLove-Summer/p/5034209.html" target="_blank" rel="external">函数调用中堆栈的个人理解
</a></p>
<h3 id="NSCoder"><a href="#NSCoder" class="headerlink" title="NSCoder"></a>NSCoder</h3><p><a href="http://www.cnblogs.com/xiaofeixiang/p/4266156.html" target="_blank" rel="external">iOS开发-数据存储NSCoder</a><br>NSCoding是一个protocol. 如果实现了NSCoding，需要实现其中的两个方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (void)encodeWithCoder:(NSCoder *)aCoder;</div><div class="line">- (id)initWithCoder:(NSCoder *)aDecoder; // NS_DESIGNATED_INITIALIZER</div></pre></td></tr></table></figure>
<p>方法中的主要的参数就是NSCoder,它是archivie字节流的抽象类.可以将数据写入一个coder,也可以从coder中读取我们写入的数据. NSCoder是一个抽象类,不能直接使用它来创建对象. 但是可以通过其子类NSKeyedUnarchiver从字节流中读取数据,NSKeyedArchiver将对象写入到字节流。</p>
<h3 id="package"><a href="#package" class="headerlink" title="@package"></a>@package</h3><p>@package变量，对于framework内部，相当于@protected， 对于framework外部，相当于@privat。</p>
<p>这个特性，很适合用于开发第三方的静态类库，因为多数人并不希望让别人知道自己属性的值。</p>
<h3 id="点）和-gt-（箭头）的区别"><a href="#点）和-gt-（箭头）的区别" class="headerlink" title=".(点）和-&gt;（箭头）的区别"></a>.(点）和-&gt;（箭头）的区别</h3><p>.(点语法）是访问类的属性，本质是调用set、get方法。</p>
<p>-&gt;是访问成员变量，但成员变量默认受保护，所以常常报错，手动设为public即可解决</p>
<h3 id="Core-Foundation框架和Cocoa-Foundation框架区别"><a href="#Core-Foundation框架和Cocoa-Foundation框架区别" class="headerlink" title="Core Foundation框架和Cocoa Foundation框架区别"></a>Core Foundation框架和Cocoa Foundation框架区别</h3><p>Core Foundation框架 (CoreFoundation.framework) 是一组C语言接口，它们为iOS应用程序提供基本数据管理和服务功能。下面列举该框架支持进行管理的数据以及可提供的服务：</p>
<ul>
<li>群体数据类型 (数组、集合等)</li>
<li>程序包</li>
<li>字符串管理</li>
<li>日期和时间管理</li>
<li>原始数据块管理</li>
<li>偏好管理</li>
<li>URL及数据流操作</li>
<li>线程和RunLoop</li>
<li>端口和soket通讯<br>Core Foundation框架和Foundation框架紧密相关，它们为相同功能提供接口，但Foundation框架提供Objective-C接口。如果您将Foundation对象和Core Foundation类型掺杂使用，则可利用两个框架之间的 “toll-free bridging”。所谓的Toll-free bridging是说您可以在某个框架的方法或函数同时使用Core Foundatio和Foundation 框架中的某些类型。很多数据类型支持这一特性，其中包括群体和字符串数据类型。每个框架的类和类型描述都会对某个对象是否为 toll-free bridged，应和什么对象桥接进行说明。</li>
</ul>
<h3 id="CoreFoundation-对于-ios开发的作用"><a href="#CoreFoundation-对于-ios开发的作用" class="headerlink" title="CoreFoundation 对于 ios开发的作用"></a>CoreFoundation 对于 ios开发的作用</h3><p>对于corefoundation一直存在疑问，一直感觉他是作为ios开发的底层接口，可是为什么很多开发者习惯于实用corefoundation接口而不是用NS库，比如CFUUIDRef，NSUUID，都可以产生UUID，但是看到的大部分代码都是使用CFUUIDRef，这是为什么呢，直接使用corefoundation接口有什么好处呢？</p>
<p>核心是和其他加框架和架构方便“沟通”。<br>The programming interfaces of Core Foundation objects have been designed for ease of use and reuse. At a general level, Core Foundation:</p>
<p>Enables sharing of code and data among various frameworks and libraries</p>
<p>Makes some degree of operating-system independence possible </p>
<p>Supports internationalization with Unicode strings</p>
<p>Provides common API and other useful capabilities, including a plug-in architecture, XML property lists, and preferences</p>
<p>Core Foundation makes it possible for the different frameworks and libraries on OS X to share code and data. Applications, libraries, and frameworks can define C routines that incorporate Core Foundation types in their external interfaces; they can thus communicate data—as Core Foundation objects—to each other through these interfaces.</p>
<h3 id="bridge-相关知识点"><a href="#bridge-相关知识点" class="headerlink" title="__bridge 相关知识点"></a>__bridge 相关知识点</h3><p><a href="http://blog.csdn.net/bsplover/article/details/7978657" target="_blank" rel="external"><strong>bridge，</strong>bridge_transfer和__bridge_retained详解</a></p>
<ul>
<li><p>__bridge只做类型转换，但是不修改对象（内存）管理权；</p>
</li>
<li><p>__bridge_retained（也可以使用CFBridgingRetain）将Objective-C的对象转换为Core Foundation的对象，同时将对象（内存）的管理权交给我们，后续需要使用CFRelease或者相关方法来释放对象；</p>
</li>
<li><p>__bridge_transfer（也可以使用CFBridgingRelease）将Core Foundation的对象转换为Objective-C的对象，同时将对象（内存）的管理权交给ARC。</p>
</li>
</ul>
<h3 id="CFMutableDictionaryRef-with-ARC"><a href="#CFMutableDictionaryRef-with-ARC" class="headerlink" title="CFMutableDictionaryRef with ARC"></a>CFMutableDictionaryRef with ARC</h3><p>如何创建并使用一个 CFMutableDictionaryRef<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CFMutableDictionaryRef myDict = CFDictionaryCreateMutable(NULL, 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">NSString *key = @&quot;someKey&quot;;</div><div class="line">NSNumber *value = [NSNumber numberWithInt: 1];</div><div class="line">CFDictionarySetValue(myDict, (__bridge void *)key, (__bridge void *)value);</div><div class="line"></div><div class="line">id dictValue = (__bridge id)CFDictionaryGetValue(myDict, (__bridge void *)key);</div><div class="line"></div><div class="line">CFDictionaryRemoveValue(myDict, (__bridge void *)key);</div></pre></td></tr></table></figure></p>
<p>如何根据 NSMutableDictionary 创建 CFMutableDictionaryRef<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSMutableDictionary *myDict = [NSMutableDictionary dictionary];</div><div class="line">NSString *key = @&quot;someKey&quot;;</div><div class="line">NSNumber *value = [NSNumber numberWithInt: 1];</div><div class="line">[myDict setObject:value forKey:key];</div><div class="line"></div><div class="line">CFMutableDictionaryRef myCFDict = CFBridgingRetain(myDict);</div><div class="line">// use myCFDict here</div><div class="line">CFRelease(myCFDict);</div></pre></td></tr></table></figure></p>
<h3 id="CoreFoundation、CFDictionaryApplyFunction"><a href="#CoreFoundation、CFDictionaryApplyFunction" class="headerlink" title="CoreFoundation、CFDictionaryApplyFunction"></a>CoreFoundation、CFDictionaryApplyFunction</h3><p>Context<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    void* object;</div><div class="line">    void* value;</div><div class="line">&#125;MyConext;</div></pre></td></tr></table></figure></p>
<p>回调c函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static void MyContextCllbackFunc(const void *_key, const void *_value, void *context) &#123;</div><div class="line">    NSLog(@&quot;%@&quot;, _key);</div><div class="line">    NSLog(@&quot;%@&quot;, _value);</div><div class="line">    NSLog(@&quot;%p&quot;, context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">NSDictionary *dict = @&#123;</div><div class="line">                           @&quot;key1&quot; : @&quot;value&quot;,</div><div class="line">                           @&quot;key2&quot; : @&quot;value&quot;,</div><div class="line">                           @&quot;key3&quot; : @&quot;value&quot;,</div><div class="line">                           &#125;;</div><div class="line"></div><div class="line">User *user = [User new];</div><div class="line"></div><div class="line">MyConext context = &#123;0&#125;;</div><div class="line">context.object = (__bridge void *)(user);</div><div class="line">context.value = @&quot;value&quot;;</div><div class="line"></div><div class="line">CFDictionaryApplyFunction((CFDictionaryRef)dict, MyContextCllbackFunc, &amp;context);</div></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2016-07-13 16:07:29.556 LJFSourceCodeLearn[5521:241563] key1</div><div class="line">2016-07-13 16:07:29.556 LJFSourceCodeLearn[5521:241563] value</div><div class="line">2016-07-13 16:07:29.556 LJFSourceCodeLearn[5521:241563] 0x7fff51eb8b88</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] key3</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] value</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] 0x7fff51eb8b88</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] key2</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] value</div><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] 0x7fff51eb8b88</div></pre></td></tr></table></figure>
<p>类似还有CFArrayApplyFunction使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">NSMutableArray *array = [NSMutableArray new];</div><div class="line">    for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">        RuntimeViewController *user = [RuntimeViewController new];</div><div class="line">        user.name = [NSString stringWithFormat:@&quot;%d%d%d&quot;, i,i,i];</div><div class="line">        [array addObject:user];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //Context结构体实例</div><div class="line">    MyConext context = &#123;0&#125;;</div><div class="line">    context.object = @&quot;hahaha&quot;;</div><div class="line">    context.value = @&quot;hello world...&quot;;</div><div class="line">    </div><div class="line">    //遍历Array数组元素，每一次传入一个函数中进行处理</div><div class="line">    CFArrayApplyFunction((CFArrayRef)array,</div><div class="line">                         CFRangeMake(0, CFArrayGetCount((CFArrayRef)array)),</div><div class="line">                         MyContextCllbackFunc2,</div><div class="line">                         &amp;context);</div></pre></td></tr></table></figure></p>
<p>C函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">static void MyContextCllbackFunc2(const void *user, void *context) &#123;</div><div class="line">    RuntimeViewController *aUser = (__bridge RuntimeViewController *)(user);</div><div class="line">    MyConext *ctx = context;</div><div class="line">    </div><div class="line">    NSLog(@&quot;aUser.name = %@&quot;, aUser.name);</div><div class="line">    NSLog(@&quot;ctx = %p&quot;, ctx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2016-07-13 16:07:29.557 LJFSourceCodeLearn[5521:241563] aUser.name = 000</div><div class="line">2016-07-13 16:07:29.558 LJFSourceCodeLearn[5521:241563] ctx = 0x7fff51eb8bd8</div><div class="line">2016-07-13 16:07:29.558 LJFSourceCodeLearn[5521:241563] aUser.name = 111</div><div class="line">2016-07-13 16:07:29.558 LJFSourceCodeLearn[5521:241563] ctx = 0x7fff51eb8bd8</div><div class="line">2016-07-13 16:07:29.558 LJFSourceCodeLearn[5521:241563] aUser.name = 222</div><div class="line">2016-07-13 16:07:29.558 LJFSourceCodeLearn[5521:241563] ctx = 0x7fff51eb8bd8</div></pre></td></tr></table></figure>
<h3 id="unsafe-unretained-修饰符"><a href="#unsafe-unretained-修饰符" class="headerlink" title="__unsafe_unretained 修饰符"></a>__unsafe_unretained 修饰符</h3><p><a href="http://blog.csdn.net/dachao_me/article/details/41011197" target="_blank" rel="external">ARC 修饰符 相关知识点</a><br>而<strong>unsafe_unretained是跟</strong>weak类似的用法，但是__unsafe_unretained会更易造成野指针，</p>
<p>并且需要注意的是，尽管ARC式的内存管理是编译器的工作，但是附有_unsafe_unretained修饰符的变量不属于编译器的内存管理对象</p>
<h3 id="kCFNull"><a href="#kCFNull" class="headerlink" title="kCFNull"></a>kCFNull</h3><p><a href="http://xiongzenghuidegithub.github.io/blog/2014/02/23/nil-nsnull-null-kcfnull/" target="_blank" rel="external">Nil NSNull NULL kCFNull</a></p>
<p>kCFNull,其宏定义，其实就是NSNull的单例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">const CFNullRef kCFNull; // the singleton null instance</div></pre></td></tr></table></figure>
<p>测试下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSNull *null1 = (id)kCFNull;</div><div class="line">NSNull *null2 = [NSNull null];</div></pre></td></tr></table></figure>
<p>输出信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSNull *) null1 = 0x0000000107b10af0</div><div class="line">(NSNull *) null2 = 0x0000000107b10af0</div></pre></td></tr></table></figure>
<p>其实 kCFNull这个宏 === [NSNull null]这一句代码</p>
<h3 id="isnan-和-isinf-函数"><a href="#isnan-和-isinf-函数" class="headerlink" title="isnan 和 isinf 函数"></a>isnan 和 isinf 函数</h3><p>math.h 文件中定义<br>isnan(x)    not a number 此宏返回一个非零值；<br>isinf(x)    当x是正无穷是返回1，当x是负无穷时返回-1。</p>
<p><a href="https://gist.github.com/mengzhu716/10970615" target="_blank" rel="external">附录:iOS 常用数学函数</a></p>
<h3 id="Dispatch-Semaphore"><a href="#Dispatch-Semaphore" class="headerlink" title="Dispatch Semaphore"></a>Dispatch Semaphore</h3><p>信号量（dispatch_semaphore）实现GCD下的并发和同步；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">        dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">        </div><div class="line">        NSMutableArray *array = [[NSMutableArray alloc] init];</div><div class="line">        </div><div class="line">//        for (int i = 0; i&lt;100000; ++i)</div><div class="line">//        &#123;</div><div class="line">//            dispatch_async(queue, ^&#123;</div><div class="line">//                [array addObject:@(i)];</div><div class="line">//            &#125;);</div><div class="line">//        &#125;</div><div class="line">        </div><div class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);</div><div class="line">        </div><div class="line">        for (int i = 0; i&lt;10000; ++i)</div><div class="line">        &#123;</div><div class="line">            dispatch_async(queue, ^&#123;</div><div class="line">                NSLog(@&quot;所在线程%@,是否是主线程:%d,addObject i = %d&quot;,[NSThread currentThread],[[NSThread currentThread] isMainThread],i);</div><div class="line">                dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">                [array addObject:@(i)];</div><div class="line">                dispatch_semaphore_signal(semaphore);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">//        NSLog(@&quot;%@&quot;,array);</div></pre></td></tr></table></figure>
<p>看到这有同学会问，把array的原子属性设置为 atomic 不就行了吗？</p>
<p>atomic 和 nonatomic 有什么区别？</p>
<p>Atomic</p>
<ul>
<li>是默认的</li>
<li>会保证 CPU 能在别的线程来访问这个属性之前，先执行完当前流程</li>
<li>速度不快，因为要保证操作整体完成</li>
</ul>
<p>Non-Atomic</p>
<ul>
<li>不是默认的</li>
<li>更快</li>
<li>线程不安全</li>
<li>如有两个线程访问同一个属性，会出现无法预料的结果</li>
</ul>
<p>假设有一个 atomic 的属性 “name”，如果线程 A 调[self setName:@”A”]，线程 B 调[self setName:@”B”]，线程 C 调[self name]，那么所有这些不同线程上的操作都将依次顺序执行——也就是说，如果一个线程正在执行 getter/setter，其他线程就得等待。因此，属性 name 是读/写安全的。</p>
<p>但是，如果有另一个线程 D 同时在调[name release]，那可能就会crash，因为 release 不受 getter/setter 操作的限制。也就是说，这个属性只能说是读/写安全的，但并不是线程安全的，因为别的线程还能进行读写之外的其他操作。线程安全需要开发者自己来保证。</p>
<p>如果 name 属性是 nonatomic 的，那么上面例子里的所有线程 A、B、C、D 都可以同时执行，可能导致无法预料的结果。如果是 atomic 的，那么 A、B、C 会串行，而 D 还是并行的。</p>
<p>所以访问 NSMutableArray 线程是不安全的。</p>
<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/ThreadSafetySummary/ThreadSafetySummary.html" target="_blank" rel="external">Thread Safety Summary &amp; Thread-Unsafe Summary </a></p>
<h3 id="回顾一下多线程相关知识"><a href="#回顾一下多线程相关知识" class="headerlink" title="回顾一下多线程相关知识"></a>回顾一下多线程相关知识</h3><h4 id="0x01-进程和线程的区别"><a href="#0x01-进程和线程的区别" class="headerlink" title="0x01:进程和线程的区别"></a>0x01:进程和线程的区别</h4><p>进程：系统分配资源的基本单位(比如CPU，内存等)，进程有自己的空间，如果一个进程崩溃不会引起其它进程的崩溃。</p>
<p>线程：程序执行的最小单位，线程没有自己独立的空间，多个线程共享的是进程的地址空间，当然处理一些基本的如程序计数器,一组寄存器和栈等。<br>如果一个线程崩溃，它所在的进程就崩溃了。 </p>
<h4 id="0x02-并行和并发"><a href="#0x02-并行和并发" class="headerlink" title="0x02:并行和并发"></a>0x02:并行和并发</h4><p>在Linux和window下，CPU的分配是根据线程数来的，如果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">总线程数&lt;= CPU数量：并行运行</div><div class="line">总线程数&gt; CPU数量：并发运行</div></pre></td></tr></table></figure></p>
<p>并行指的是，当你的CPU核数比线程数多的话，则会将每个线程都分在一个CPU核里进行处理。</p>
<p>并发指的是，当你的CPU核数比线程数少的话，则会利用“时间片轮转进程调度算法”，对每个线程进行同等的运行。</p>
<p>并行要求并发，但并发并不能保证并行。</p>
<h4 id="0x03-GCD复习"><a href="#0x03-GCD复习" class="headerlink" title="0x03:GCD复习"></a>0x03:GCD复习</h4><ul>
<li>GCD 术语<ul>
<li>Serial vs. Concurrent 串行 vs. 并发<br>  任务串行执行就是每次只有一个任务被执行，任务并发执行就是在同一时间可以有多个任务被执行。</li>
<li>Synchronous vs. Asynchronous 同步 vs. 异步<br>  一个同步函数只在完成了它预定的任务后才返回。一个异步函数，刚好相反，会立即返回，预定的任务会完成但不会等它完成。</li>
<li>Critical Section 临界区<br>  一段代码不能被并发执行，也就是，两个线程不能同时执行这段代码。</li>
<li>Race Condition 竞态条件<br>  这种状况是指基于特定序列或时机的事件的软件系统以不受控制的方式运行的行为，例如程序的并发任务执行的确切顺序。竞态条件可导致无法预测的行为，而不能通过代码检查立即发现。</li>
<li>Deadlock 死锁<br>  两个（有时更多）东西——在大多数情况下，是线程——所谓的死锁是指它们都卡住了，并等待对方完成或执行其它操作。第一个不能完成是因为它在等待第二个的完成。但第二个也不能完成，因为它在等待第一个的完成。</li>
<li>Thread Safe 线程安全<br>  线程安全的代码能在多线程或并发任务中被安全的调用，而不会导致任何问题（数据损坏，崩溃，等）。线程不安全的代码在某个时刻只能在一个上下文中运行。一个线程安全代码的例子是 NSDictionary 。你可以在同一时间在多个线程中使用它而不会有问题。另一方面，NSMutableDictionary 就不是线程安全的，应该保证一次只能有一个线程访问它。</li>
<li>Context Switch 上下文切换<br>  一个上下文切换指当你在单个进程里切换执行不同的线程时存储与恢复执行状态的过程。这个过程在编写多任务应用时很普遍，但会带来一些额外的开销。</li>
</ul>
</li>
<li>Syn</li>
<li>Asyn</li>
<li>SerialQueue</li>
<li>ConcurrentQueue</li>
<li>After</li>
<li>Group</li>
<li>Barrier</li>
<li>Apply</li>
<li>Once</li>
<li>FunctionPoint</li>
<li>MainThread</li>
<li>Supspend</li>
<li>Resume</li>
<li>Semaphore</li>
<li>Set_target_queue</li>
</ul>
<h3 id="Obejctive-C-runtime-编码类型"><a href="#Obejctive-C-runtime-编码类型" class="headerlink" title="Obejctive-C runtime 编码类型"></a>Obejctive-C runtime 编码类型</h3><h4 id="type-Encoding"><a href="#type-Encoding" class="headerlink" title="type Encoding"></a>type Encoding</h4><p>我们使用的一些数据类型，实际上最终由编译器解析成类似T@”Car”,&amp;,N,V_car这样的一串字符</p>
<ul>
<li>objc_property_attribute_t 属性特征值（编码）结构体<ul>
<li>属性的编码都是以T字符开始，获取属性声明的Ivar的 数据类型，如: T@User获取自定义类型User；</li>
<li>V字符，获取属性声明的Ivar的 变量名；</li>
<li>以及其他字符，获取对应的数据 对应下表；</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Person类的所有属性（Ivar）的 `最终数据类型` 由编译器编译成一串特定格式的字符</div><div class="line"></div><div class="line">属性名 = car  , 属性@encode()编码 = T@&quot;Car&quot;,&amp;,N,V_car</div><div class="line">属性名 = name , 属性@encode()编码 = T@&quot;NSString&quot;,C,N,V_name</div><div class="line">属性名 = age  , 属性@encode()编码 = Tq,N,V_age</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">自定义类型</div><div class="line">@property Car *car; &gt;&gt;&gt;&gt;&gt;&gt; T@&quot;Car&quot;,&amp;,N,V_car</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Foundation类型</div><div class="line">@property NSString *name; &gt;&gt;&gt;&gt;&gt;&gt; T@&quot;NSString&quot;,C,N,V_name</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">基本数据类型</div><div class="line">@property NSInteger age; &gt;&gt;&gt;&gt;&gt;&gt; Tq,N,V_age</div></pre></td></tr></table></figure>
<ul>
<li>解析最前面T开头的一段字符串<ul>
<li>T@User &gt;&gt;&gt; 属性变量类型是 User；</li>
<li>Ti &gt;&gt;&gt; 属性变量类型是 int；</li>
<li>TB &gt;&gt;&gt; 属性变量类型是 bool、BOOL；</li>
<li>TD &gt;&gt;&gt; 属性变量类型是 Double；</li>
<li>Tf &gt;&gt;&gt; 属性变量类型是 float；</li>
<li>等等；</li>
</ul>
</li>
</ul>
<p>苹果会对我们在代码中使用的所有数据类型，进行额外的一次编码，编码成最终iOS系统所能识别的数据类型.</p>
<p><img src="http://7xraw1.com1.z0.glb.clouddn.com/Declared%20property%20type%20encodings-OC.png" alt=""></p>
<p><img src="http://7xraw1.com1.z0.glb.clouddn.com/OC%20type%20encodings.png" alt=""></p>
<p><img src="http://7xraw1.com1.z0.glb.clouddn.com/OC%20method%20encodings.png" alt=""></p>
<h3 id="Runtime-MetaClass"><a href="#Runtime-MetaClass" class="headerlink" title="Runtime MetaClass"></a>Runtime MetaClass</h3><h4 id="Objective-c-中的-每一个类-如-Person类-其实包含两部分"><a href="#Objective-c-中的-每一个类-如-Person类-其实包含两部分" class="headerlink" title="Objective-c 中的 每一个类 如: Person类 其实包含两部分"></a>Objective-c 中的 每一个类 如: Person类 其实包含两部分</h4><ul>
<li>普通类（类本身）<ul>
<li>如 person 类本身（我们创建的类）</li>
</ul>
</li>
<li>元类（系统创建）<ul>
<li>Meta Person类，由系统默认创建</li>
<li>这个创建Meta Person类的过程，我们不知道而已</li>
</ul>
</li>
</ul>
<h4 id="关于meta-class的系统方法"><a href="#关于meta-class的系统方法" class="headerlink" title="关于meta class的系统方法"></a>关于meta class的系统方法</h4><ul>
<li><p>判断一个objc_class实例是否是Meta类的Class</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BOOL class_isMetaClass(Class cls)</div></pre></td></tr></table></figure>
</li>
<li><p>获取一个NSObject类对应的Meta类的Class</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Class objc_getMetaClass(const char *name)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="类-与-Meta类"><a href="#类-与-Meta类" class="headerlink" title="类 与 Meta类"></a>类 与 Meta类</h4><ul>
<li>类，存放对象的相关数据<ul>
<li>实例成员变量</li>
<li>实例方法</li>
</ul>
</li>
<li>Meta类，存放类的先关数据<ul>
<li>类的成员变量（static 类成员变量）</li>
<li>类方法（+开头的方法）</li>
</ul>
</li>
<li>区分 对象方法 与 类方法 调用过程<ul>
<li>向一个对象发送消息<ul>
<li>通过对象的 isa指针找到 对象所属类对应的的 objc_class结构体实例</li>
<li>然后开始查找objc_class实例的 method_list 查找 Method</li>
</ul>
</li>
<li>向一个类发送消息<ul>
<li>通过类Class的 isa指针找到 Meta类对应的 objc_class结构体实例</li>
<li>然后从objc_class实例的 method_list 查找 Method</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="结合-Demo-中-Runtime-MataClass"><a href="#结合-Demo-中-Runtime-MataClass" class="headerlink" title="结合 Demo 中 Runtime_MataClass"></a>结合 Demo 中 Runtime_MataClass</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">#import &quot;RuntimeViewController.h&quot;</div><div class="line"></div><div class="line">@interface RuntimeViewController ()</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">void ReportFunction(id self, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    //1. 对象</div><div class="line">    NSLog(@&quot;This object is %p.&quot;, self);</div><div class="line">    </div><div class="line">    //2. 对象所属的类</div><div class="line">    NSLog(@&quot;Class is %@&quot;, [self class]);</div><div class="line">    </div><div class="line">    //3. 所属类的父类</div><div class="line">    NSLog(@&quot;super is %@.&quot;,[self superclass]);</div><div class="line">    </div><div class="line">    //4. 每一个类都有两部分</div><div class="line">    //类的第一部分、类本身</div><div class="line">    //类的第二部分、元类</div><div class="line">    Class currentClass = [self class];</div><div class="line">    for (int i = 1; i &lt; 10; i++)//i的次数随便改都可以</div><div class="line">    &#123;</div><div class="line">        NSLog(@&quot;Following the isa pointer times = %d, ClassValue = %@, ClassAddress = %p&quot;, i, currentClass, currentClass);</div><div class="line">        </div><div class="line">        //通过Class的 isa指针 找到 MetaClass</div><div class="line">        currentClass = object_getClass(currentClass);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //5. NSObject类本身</div><div class="line">    NSLog(@&quot;NSObject&apos;s class is %p&quot;, [NSObject class]);</div><div class="line">    </div><div class="line">    //6. NSObject类的元类</div><div class="line">    NSLog(@&quot;NSObject&apos;s meta class is %p&quot;, object_getClass([NSObject class]));</div><div class="line">&#125;</div><div class="line"></div><div class="line">@implementation RuntimeViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    // Do any additional setup after loading the view.</div><div class="line">    </div><div class="line">    [self setOSProps];</div><div class="line">    </div><div class="line">    //运行时创建类</div><div class="line">    [self createClass];</div><div class="line">    </div><div class="line">    [self imp_implementationWithBlock];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setOSProps</div><div class="line">&#123;</div><div class="line">    self.view.backgroundColor = [UIColor whiteColor];</div><div class="line">    self.navigationItem.title = @&quot;Runtime Meta Learn&quot;;</div><div class="line">    self.navigationController.navigationBar.translucent = YES;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)createClass</div><div class="line">&#123;</div><div class="line">    //1. 创建一个Class</div><div class="line">    Class MyClass = objc_allocateClassPair([NSObject class],</div><div class="line">                                           &quot;myclass&quot;,</div><div class="line">                                           0);</div><div class="line">    </div><div class="line">    //2. 添加一个NSString的变量，第四个参数是对其方式，第五个参数是参数类型</div><div class="line">    if (class_addIvar(MyClass, &quot;itest&quot;, sizeof(NSString *), 0, &quot;@&quot;)) &#123;</div><div class="line">        NSLog(@&quot;add ivar success&quot;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //3. 添加一个函数</div><div class="line">    class_addMethod(MyClass,</div><div class="line">                    @selector(report),</div><div class="line">                    (IMP)ReportFunction,</div><div class="line">                    &quot;v@:&quot;);</div><div class="line">    </div><div class="line">    //4. 注册这个类到runtime系统中就可以使用他了</div><div class="line">    objc_registerClassPair(MyClass);</div><div class="line">    </div><div class="line">    //5. 测试创建的类</div><div class="line">    [self test:MyClass];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)report &#123;</div><div class="line">    //什么都不做，只是为了OC对象能够调用到c函数</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)test:(Class)class &#123;</div><div class="line">    </div><div class="line">    //1.</div><div class="line">    id obj = [[class alloc] init];</div><div class="line">    </div><div class="line">    //2.</div><div class="line">    [obj report];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>控制台输出如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">2016-07-12 11:37:23.281 LJFSourceCodeLearn[1353:75617] add ivar success</div><div class="line">2016-07-12 11:37:23.281 LJFSourceCodeLearn[1353:75617] This object is 0x7ff42bc291d0.</div><div class="line">2016-07-12 11:37:23.281 LJFSourceCodeLearn[1353:75617] Class is myclass</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] super is NSObject.</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 1, ClassValue = myclass, ClassAddress = 0x7ff42bf0f180</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 2, ClassValue = myclass, ClassAddress = 0x7ff42bf36550</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 3, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 4, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 5, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.282 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 6, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.304 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 7, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.304 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 8, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.304 LJFSourceCodeLearn[1353:75617] Following the isa pointer times = 9, ClassValue = NSObject, ClassAddress = 0x110ecb198</div><div class="line">2016-07-12 11:37:23.304 LJFSourceCodeLearn[1353:75617] NSObject&apos;s class is 0x110ecb170</div><div class="line">2016-07-12 11:37:23.304 LJFSourceCodeLearn[1353:75617] NSObject&apos;s meta class is 0x110ecb198</div></pre></td></tr></table></figure>
<ul>
<li>方法object_getClass(id obj)会根据 Class的私有成员变量isa指针 找到一个类，有两种情况:<ul>
<li>对象的isa &gt;&gt;&gt; 所属类</li>
<li>类的isa &gt;&gt;&gt; Meta 类</li>
<li>Meta类的isa &gt;&gt;&gt; Meta NSObject</li>
<li>Meta NSObject的isa &gt;&gt;&gt; 永远指向自己，形成环路</li>
</ul>
</li>
<li>times = 2时、根据myclass-&gt;isa指针，找到其对应的 Meta myclass</li>
<li>times = 3时、根据 Meta myclass-&gt;isa 指针，找到了 Meta NSObject</li>
<li>times = 4，5，6，7，8…、根据 元类NSObject 的 isa指针，最后都是指向自己</li>
</ul>
<h4 id="使用imp-implementationWithBlock-替代上面例子需要一个辅助的static-c函数来完成运行时创建Class"><a href="#使用imp-implementationWithBlock-替代上面例子需要一个辅助的static-c函数来完成运行时创建Class" class="headerlink" title="使用imp_implementationWithBlock()替代上面例子需要一个辅助的static c函数来完成运行时创建Class."></a>使用imp_implementationWithBlock()替代上面例子需要一个辅助的static c函数来完成运行时创建Class.</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">- (void)imp_implementationWithBlock</div><div class="line">&#123;</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///创建一个类</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    Class People = objc_allocateClassPair([NSObject class], &quot;People&quot;, 0);</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///添加两个变量</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    </div><div class="line">    if (class_addIvar(People, &quot;name&quot;, sizeof(NSString *), 0, @encode(NSString *))) &#123;</div><div class="line">        NSLog(@&quot;add ivar name success&quot;);</div><div class="line">    &#125;</div><div class="line">    if (class_addIvar(People, &quot;age&quot;, sizeof(int), 0, @encode(int))) &#123;</div><div class="line">        NSLog(@&quot;add ivar age success&quot;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///创建方法的SEL</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    SEL selector = sel_registerName(&quot;talk:&quot;);</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///创建方法的IMP指针，并指向Block给出的代码</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    IMP impl = imp_implementationWithBlock(^(id self, NSString *arg1)&#123;</div><div class="line">        </div><div class="line">        //age变量值</div><div class="line">        //通过KVC</div><div class="line">        //int age = (int)[[self valueForKey:@&quot;age&quot;] integerValue];</div><div class="line">        </div><div class="line">        //通过Ivar</div><div class="line">        Ivar ageIvar = class_getInstanceVariable([self class], &quot;age&quot;);</div><div class="line">        int age  = (int)[object_getIvar(self, ageIvar) integerValue];</div><div class="line">        </div><div class="line">        </div><div class="line">        //name变量值</div><div class="line">        //通过KVC</div><div class="line">        //NSString *name = [self valueForKey:@&quot;name&quot;];</div><div class="line">        </div><div class="line">        //通过Ivar</div><div class="line">        Ivar nameIvar = class_getInstanceVariable([self class], &quot;name&quot;);</div><div class="line">        NSString *name = object_getIvar(self, nameIvar);</div><div class="line">        </div><div class="line">        NSLog(@&quot;age = %d, name = %@, msgSay = %@&quot;, age, name, arg1);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///添加一个方法, 将SEL与IMP组装成一个Method结构体实例，添加到Class中的 method_list数组</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    class_addMethod(People, selector, impl, &quot;v@:@&quot;);</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///注册这个类到系统</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    objc_registerClassPair(People);</div><div class="line">    </div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///生成一个实例</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    id instanceP = [[People alloc] init];</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///给Ivar赋值</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    </div><div class="line">    //通过KVC赋值</div><div class="line">    [instanceP setValue:@&quot;变量字符串值&quot; forKey:@&quot;name&quot;];</div><div class="line">    //[instanceP setValue:@19 forKey:@&quot;age&quot;];</div><div class="line">    </div><div class="line">    //通知Ivar赋值</div><div class="line">    Ivar ageIvar = class_getInstanceVariable(People, &quot;age&quot;);</div><div class="line">    object_setIvar(instanceP, ageIvar, @19);</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///发送消息</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ((void (*)(id, SEL, NSString *))(void *) objc_msgSend)(instanceP, selector, @&quot;参数值&quot;);</div><div class="line">    </div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    ///释放对象、销毁类</div><div class="line">    //////////////////////////////////////////////////////</div><div class="line">    instanceP = nil;</div><div class="line">    objc_disposeClassPair(People);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>方法的编码格式:<ul>
<li>v@: &gt;&gt;&gt; 返回值void，参数1:self,参数2:SEL &gt;&gt;&gt; - (void)funcName;</li>
<li>v@:@ &gt;&gt;&gt; 返回值void，参数1:self,参数2:SEL, 参数3:NSString<em> &gt;&gt;&gt; - (void)funcName:(NSSring </em>)name;</li>
</ul>
</li>
<li>对应的Objective-C方法的SEL也应该是 &gt;&gt;&gt; talk:带一个参数</li>
<li>imp_implementationWithBlock()接收一个添加方法被调用时的回调Block<ul>
<li>其格式为: method_return_type ^(id self, method_args …)</li>
</ul>
</li>
</ul>
<h4 id="Meta-Class-元类"><a href="#Meta-Class-元类" class="headerlink" title="Meta Class 元类"></a>Meta Class 元类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Class objc_allocateClassPair(Class superclass,</div><div class="line">                           const char *name,</div><div class="line">                           size_t extraBytes)</div></pre></td></tr></table></figure>
<ul>
<li>函数名 objc_allocateClassPair.. 中的 ClassPair意思是说一对Class.</li>
<li>但是该函数只返回了一个Class</li>
<li>没有被返回的另一个Class就是 MetaClass 元类，由系统创建.</li>
<li>Meta Class与普通类Class 都是结构体 objc_class实例</li>
</ul>
<h4 id="Objective-c中的-对象-与-类"><a href="#Objective-c中的-对象-与-类" class="headerlink" title="Objective-c中的 对象 与 类"></a>Objective-c中的 对象 与 类</h4><p>类</p>
<p>经常写获取一个对象的类型Class的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Class cls = [Person class];</div></pre></td></tr></table></figure>
<p>就用到了Class这个数据结构，其定义为如下，可以得到Class是 结构体objc_class实例的 指针类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_class *Class;</div></pre></td></tr></table></figure>
<p>那么能够成为一个类（Class）的数据结构为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">struct objc_class &#123;</div><div class="line"></div><div class="line">  /* </div><div class="line">     又指向一个结构体objc_class实例 </div><div class="line">     类的isa指针，指向类的 元类 MetaClass</div><div class="line"> */</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line"></div><div class="line">#if !__OBJC2__</div><div class="line"></div><div class="line">  /**</div><div class="line">     指向其父类(普通类)</div><div class="line">  */</div><div class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</div><div class="line"></div><div class="line">    const char *name                                         OBJC2_UNAVAILABLE;</div><div class="line">    long version                                             OBJC2_UNAVAILABLE;</div><div class="line">    long info                                                OBJC2_UNAVAILABLE;</div><div class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;</div><div class="line"></div><div class="line">    /**</div><div class="line">     方法列表</div><div class="line">     */</div><div class="line">    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;</div><div class="line"></div><div class="line">    /**</div><div class="line">     方法缓存</div><div class="line">     */</div><div class="line"></div><div class="line">    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;</div><div class="line"></div><div class="line">    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div><div class="line">/* Use `Class` instead of `struct objc_class *` */</div></pre></td></tr></table></figure>
<p>而Class数据结构中最重要的一个数据项是 Class isa; 这样的isa指针.</p>
<p>对象</p>
<p>能够成为一个对象（Object）的数据结构如下，可以看到对象数据结构中最重要的就是Class isa;指针项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">struct objc_object &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">     对象的isa指针，指向其 所属类本身（不是元类）    </div><div class="line">  */</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Class是struct objc_class的指针类型，那么struct objc_object也有其对于的指针类型</p>
<ul>
<li>调用类方法与对象方法<ul>
<li>给对象发送消息时，消息是在对象所属类的方法列表method_list或cache中查询Method</li>
<li>给类发消息时，消息是在这个类的元类 meta class的方法列表或缓存中查询Method</li>
</ul>
</li>
</ul>
<p>所以也就是说对象方法与类方法存放地点的不同</p>
<ul>
<li>对象方法、存放在 类本身</li>
<li>类方法、存放在 类的元类MetaClass</li>
</ul>
<p>所以，元类是必不可少的，它存储了类的所有类方法</p>
<h4 id="对象、类、元类三者之间的关系图"><a href="#对象、类、元类三者之间的关系图" class="headerlink" title="对象、类、元类三者之间的关系图"></a>对象、类、元类三者之间的关系图</h4><p><img src="http://7xraw1.com1.z0.glb.clouddn.com/runtime_meta_class.png" alt=""></p>
<p><img src="http://7xraw1.com1.z0.glb.clouddn.com/runtime_mata_class_son.png" alt=""></p>
<ul>
<li>对象的 isa指针 指向 所属类</li>
<li>每一个类，都有一个 isa指针 指向一个 唯一的 MetaClass</li>
<li>每一个Meta Class，拥有的 isa指针 都指向 顶层 NSObject Meta Class</li>
<li>最上层的Meta Class（Meta NSObject）的isa指针指向自己，形成一个 回路</li>
<li>类本身的 super_class 指向其父类，如果该类为根类则值为 nil</li>
<li>每一个 MetaClass 的 super_class指针 都指向其 原本Class的superClass对应的 MetaClass<ul>
<li>特列: 但是最上层的 Meta Class 的 super_class 指针，指向的却是 NSObject 原本 Class</li>
</ul>
</li>
</ul>
<h4 id="所有的-类-NSObject子类-都是-objc-class结构体-的实例"><a href="#所有的-类-NSObject子类-都是-objc-class结构体-的实例" class="headerlink" title="所有的 类 NSObject子类 都是 objc_class结构体 的实例"></a>所有的 类 NSObject子类 都是 objc_class结构体 的实例</h4><p>NSObject类获取Class的源码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (Class)class &#123;</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Class是 objc_class结构体实例的指针变量类型</li>
<li>那么+[NSObject class]返回就是一个 objc_class结构体实例</li>
<li>而 self 一般是 一个指向对象地址的指针</li>
<li>而此时的 self 所代表的就是 NSObject类本身</li>
</ul>
<p>那么可以猜测: NSObject 是 objc_class的实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@implementation RuntimeViewController</div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    </div><div class="line">    //名字</div><div class="line">    NSLog(@&quot;%@&quot;, [RuntimeViewController class]);</div><div class="line"></div><div class="line">    //多次输出其地址</div><div class="line">    NSLog(@&quot;%p&quot;, [self class]);</div><div class="line">    NSLog(@&quot;%p&quot;, [self class]);</div><div class="line">    NSLog(@&quot;%p&quot;, [RuntimeViewController class]);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-07-12 13:30:27.264 LJFSourceCodeLearn[1640:121986] RuntimeViewController</div><div class="line">2016-07-12 13:30:27.265 LJFSourceCodeLearn[1640:121986] 0x101d03cd0</div><div class="line">2016-07-12 13:30:27.265 LJFSourceCodeLearn[1640:121986] 0x101d03cd0</div><div class="line">2016-07-12 13:30:27.265 LJFSourceCodeLearn[1640:121986] 0x101d03cd0</div></pre></td></tr></table></figure>
<p>每一个NSObject类在运行阶段，是按照一个单例保存</p>
<hr>
<p>才疏学浅，有理解错误的地方，欢迎指出。</p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/jianfeishuo.jpg" alt="李剑飞 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎订阅我的微信公众号"剑飞说"！</div>
</div>


      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="李剑飞 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.png" alt="李剑飞 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      李剑飞
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.lijianfei.cn/2016/07/13/learnYYModelSomeGain/" title="看 YYModel 源码的一些收获">http://www.lijianfei.cn/2016/07/13/learnYYModelSomeGain/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/21/objective-block-learning/" rel="next" title="Objective-C中block实现和技巧学习">
                <i class="fa fa-chevron-left"></i> Objective-C中block实现和技巧学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/20/RN-Rudex-Exp/" rel="prev" title="近期 React-Native  With Redux  开发的一点心得">
                近期 React-Native  With Redux  开发的一点心得 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="李剑飞" />
          <p class="site-author-name" itemprop="name">李剑飞</p>
           
              <p class="site-description motion-element" itemprop="description">本站没有添加评论，扫二维码加我微信好友，咨询文章的疑问点。本站只发布原创内容，我的学习笔记会记录在下面的 Wiki 链接中。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lijianfeigeek" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1855052150" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/lijianfei_" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/lijianfeigeek/lijianfeigeek.github.io/wiki" target="_blank" title="Wiki">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Wiki
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lijianfei.deercv.com/" target="_blank" title="Resume">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Resume
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#编程随想：学习技术的三部曲"><span class="nav-number">1.</span> <span class="nav-text">编程随想：学习技术的三部曲</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于源码学习自己的一些感悟"><span class="nav-number">2.</span> <span class="nav-text">关于源码学习自己的一些感悟</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于分享"><span class="nav-number">3.</span> <span class="nav-text">关于分享</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#YYModel-作者性能优化的几个-Tip："><span class="nav-number">4.</span> <span class="nav-text">YYModel 作者性能优化的几个 Tip：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#YYModel-源码学习篇"><span class="nav-number">5.</span> <span class="nav-text">YYModel 源码学习篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#把不熟练的一些代码挑出来，弄清楚"><span class="nav-number">5.1.</span> <span class="nav-text">把不熟练的一些代码挑出来，弄清楚</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NS-ASSUME-NONNULL-BEGIN-NS-ASSUME-NONNULL-END"><span class="nav-number">5.1.1.</span> <span class="nav-text">NS_ASSUME_NONNULL_BEGIN / NS_ASSUME_NONNULL_END</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#define-force-inline-inline-attribute-always-inline"><span class="nav-number">5.1.2.</span> <span class="nav-text">#define force_inline inline attribute((always_inline))</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSCoder"><span class="nav-number">5.1.3.</span> <span class="nav-text">NSCoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#package"><span class="nav-number">5.1.4.</span> <span class="nav-text">@package</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#点）和-gt-（箭头）的区别"><span class="nav-number">5.1.5.</span> <span class="nav-text">.(点）和->（箭头）的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Foundation框架和Cocoa-Foundation框架区别"><span class="nav-number">5.1.6.</span> <span class="nav-text">Core Foundation框架和Cocoa Foundation框架区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CoreFoundation-对于-ios开发的作用"><span class="nav-number">5.1.7.</span> <span class="nav-text">CoreFoundation 对于 ios开发的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bridge-相关知识点"><span class="nav-number">5.1.8.</span> <span class="nav-text">__bridge 相关知识点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CFMutableDictionaryRef-with-ARC"><span class="nav-number">5.1.9.</span> <span class="nav-text">CFMutableDictionaryRef with ARC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CoreFoundation、CFDictionaryApplyFunction"><span class="nav-number">5.1.10.</span> <span class="nav-text">CoreFoundation、CFDictionaryApplyFunction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafe-unretained-修饰符"><span class="nav-number">5.1.11.</span> <span class="nav-text">__unsafe_unretained 修饰符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kCFNull"><span class="nav-number">5.1.12.</span> <span class="nav-text">kCFNull</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isnan-和-isinf-函数"><span class="nav-number">5.1.13.</span> <span class="nav-text">isnan 和 isinf 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dispatch-Semaphore"><span class="nav-number">5.1.14.</span> <span class="nav-text">Dispatch Semaphore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回顾一下多线程相关知识"><span class="nav-number">5.1.15.</span> <span class="nav-text">回顾一下多线程相关知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#0x01-进程和线程的区别"><span class="nav-number">5.1.15.1.</span> <span class="nav-text">0x01:进程和线程的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x02-并行和并发"><span class="nav-number">5.1.15.2.</span> <span class="nav-text">0x02:并行和并发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x03-GCD复习"><span class="nav-number">5.1.15.3.</span> <span class="nav-text">0x03:GCD复习</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Obejctive-C-runtime-编码类型"><span class="nav-number">5.1.16.</span> <span class="nav-text">Obejctive-C runtime 编码类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#type-Encoding"><span class="nav-number">5.1.16.1.</span> <span class="nav-text">type Encoding</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-MetaClass"><span class="nav-number">5.1.17.</span> <span class="nav-text">Runtime MetaClass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Objective-c-中的-每一个类-如-Person类-其实包含两部分"><span class="nav-number">5.1.17.1.</span> <span class="nav-text">Objective-c 中的 每一个类 如: Person类 其实包含两部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关于meta-class的系统方法"><span class="nav-number">5.1.17.2.</span> <span class="nav-text">关于meta class的系统方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类-与-Meta类"><span class="nav-number">5.1.17.3.</span> <span class="nav-text">类 与 Meta类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结合-Demo-中-Runtime-MataClass"><span class="nav-number">5.1.17.4.</span> <span class="nav-text">结合 Demo 中 Runtime_MataClass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用imp-implementationWithBlock-替代上面例子需要一个辅助的static-c函数来完成运行时创建Class"><span class="nav-number">5.1.17.5.</span> <span class="nav-text">使用imp_implementationWithBlock()替代上面例子需要一个辅助的static c函数来完成运行时创建Class.</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Meta-Class-元类"><span class="nav-number">5.1.17.6.</span> <span class="nav-text">Meta Class 元类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Objective-c中的-对象-与-类"><span class="nav-number">5.1.17.7.</span> <span class="nav-text">Objective-c中的 对象 与 类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对象、类、元类三者之间的关系图"><span class="nav-number">5.1.17.8.</span> <span class="nav-text">对象、类、元类三者之间的关系图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#所有的-类-NSObject子类-都是-objc-class结构体-的实例"><span class="nav-number">5.1.17.9.</span> <span class="nav-text">所有的 类 NSObject子类 都是 objc_class结构体 的实例</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李剑飞</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
